---
title: "DTI_MTES_CODING"
author: "Daniel Zweben"
date: "2024-11-03"
output: html_document
---
#### READ IN DATA FRAME FROM REDCAP #####

```{r}
# read CSV into a dataframe
df <- read.csv("/Users/dannyzweben/Desktop/CABLAB_Files/deft/coding/lite-study2/lites2.csv", 
               stringsAsFactors = FALSE)

```

#### CALCULATE MTES Z SCORES ####

```{r}
library(dplyr)

df <- df %>%
  mutate(
    across(c(MTES_SocialMediaUse_TimeOnApp.sum,
             MTES_PhoneChecking.mean,
             MTES_PublicUpdates.mean),
           ~ scale(.)[,1],
           .names = "{.col}.z"),
    mtes_zscore = rowMeans(across(ends_with(".z")), na.rm = TRUE)
  )

```

#### ADD YRBS EVER SCORE: ####

```{r}
# read CSV into a dataframe
df_yrbs <- read.csv("/Users/dannyzweben/Desktop/CABLAB_Files/deft/coding/lite-study2/Lite_variables/yrbs.csv", 
               stringsAsFactors = FALSE)

# keep only rows where PID is in df (to match LITe inclusion)
# Rename pid_assignment → PID
names(df_yrbs)[names(df_yrbs) == "pid_assignment"] <- "PID"
# Remove any decimal part (e.g., ".1", ".2", etc.)
df_yrbs$PID <- sub("\\..*$", "", as.character(df_yrbs$PID))
# Convert to numeric for consistency
df_yrbs$PID <- as.numeric(df_yrbs$PID)
# Filter so only PIDs that are also in df remain
df_yrbs <- df_yrbs[df_yrbs$PID %in% df$PID, ]

df_yrbs$yrbs_var <- rowMeans(
  data.frame(
    # Alcohol: not equal to 1 = tried
    alc = ifelse(df_yrbs$yrbs_alcfirst != 1 & !is.na(df_yrbs$yrbs_alcfirst), 1, 0),
    # Cigarettes
    cig = ifelse(df_yrbs$yrbs_cig_try == 1, 1, 0),
    # Vaping
    vape = ifelse(df_yrbs$yrbs_vape_use == 1, 1, 0),
    # Marijuana: not equal to 1 = tried
    mj = ifelse(df_yrbs$yrbs_mjuse != 1 & !is.na(df_yrbs$yrbs_mjuse), 1, 0),
    # Prescription misuse: not equal to 1 = tried
    rx = ifelse(df_yrbs$yrbs_rxuse != 1 & !is.na(df_yrbs$yrbs_rxuse), 1, 0),
    # Inhalants: not equal to 1 = tried
    inh = ifelse(df_yrbs$yrbs_inhalants != 1 & !is.na(df_yrbs$yrbs_inhalants), 1, 0),
    # Cocaine: not equal to 1 = tried
    cocaine = ifelse(df_yrbs$yrbs_cocain != 1 & !is.na(df_yrbs$yrbs_cocain), 1, 0)
  ),
  na.rm = TRUE
)

## # new df with just PID and score
df_yrbs_var <- df_yrbs[, c("PID", "yrbs_var")]
df_yrbs <- df_yrbs[df_yrbs$PID != 2113, ] # REMOVE THE


# merge into df by PID
df <- merge(df, df_yrbs_var, by = "PID", all.x = TRUE)
```

#### Z SCORING COGNITIVE VARIABLES AND PNRT AND OUTLIER REMOVAL ####

```{r}
library(dplyr)
df$foraging <- as.numeric(df$foraging)
df <- df %>%
  mutate(
    across(c(ParasocialUsage, SocialUsage, zuckerman.mean, barrets.sum, yrbs_var, positiverisk_ever_mean, negativerisk_ever_mean, foraging),
           ~ scale(.)[,1],
           .names = "{.col}.z")
  ) %>%
  mutate(
    across(c(ParasocialUsage, SocialUsage, zuckerman.mean, barrets.sum, yrbs_var, positiverisk_ever_mean, negativerisk_ever_mean, foraging),
           ~ ifelse(abs(get(paste0(cur_column(), ".z"))) > 3, NA, .),
           .names = "{.col}")
  ) %>%
  mutate(
    across(ends_with(".z"),
           ~ ifelse(abs(.) > 3, NA, .))
  )

```

 #### Add total_risk to the full df:
(average of positive risk, negative risk, and YRBS z-score) ####

```{r}
# df <- df %>%
#   mutate(total_risk = rowMeans(across(c(positiverisk_ever_mean.z,
#                                         negativerisk_ever_mean.z,
#                                         yrbs_var.z)),
#                                na.rm = TRUE))


df <- df %>%
  mutate(
    # total risk = average across three domains
    total_risk = rowMeans(dplyr::select(., negativerisk_ever_mean, 
                                      positiverisk_ever_mean, 
                                      yrbs_var),
                          na.rm = TRUE),
    # z-scored total risk
    total_risk = as.numeric(scale(total_risk))
  )

```

#### REVERESE SCORE FORAGING ####

```{r}
df <- df %>%
  mutate(foraging = ifelse(foraging == 0, NA, foraging))
df <- df %>% mutate(foraging = -1 * foraging) 
df <- df %>% mutate(foraging.z = -1 * foraging.z) 

```

#### Create df_run subset with only the analysis-ready variables, ####

```{r}
df_run <- df %>%
  dplyr::select(PID, sex, positiverisk_ever_mean.z, mtes_zscore,
         zuckerman.mean.z, barrets.sum.z,
         positiverisk_ever_mean.z, negativerisk_ever_mean.z, yrbs_var.z,
         total_risk, ParasocialUsage.z, SocialUsage.z, foraging.z)
```

#### Run original - Total Risk Variety Correlations
```{r}
library(Hmisc)

# variables of interest
vars <- c("total_risk", "zuckerman.mean.z", "barrets.sum.z", "mtes_zscore", "foraging.z")

# --- Teen cohort (<3000) ---
teen_df <- df_run %>% filter(PID < 3000)
res_teen <- rcorr(as.matrix(teen_df[vars]))

rp_mat_teen <- matrix("", ncol = length(vars), nrow = length(vars))
rp_mat_teen[lower.tri(rp_mat_teen)] <- paste0(
  round(res_teen$r[lower.tri(res_teen$r)], 2),
  ", p=", round(res_teen$P[lower.tri(res_teen$P)], 3)
)
colnames(rp_mat_teen) <- rownames(rp_mat_teen) <- vars
teen_corrs <- as.data.frame(rp_mat_teen)

# --- Adult cohort (>3000) ---
adult_df <- df_run %>% filter(PID > 3000)
res_adult <- rcorr(as.matrix(adult_df[vars]))

rp_mat_adult <- matrix("", ncol = length(vars), nrow = length(vars))
rp_mat_adult[lower.tri(rp_mat_adult)] <- paste0(
  round(res_adult$r[lower.tri(res_adult$r)], 2),
  ", p=", round(res_adult$P[lower.tri(res_adult$P)], 3)
)
colnames(rp_mat_adult) <- rownames(rp_mat_adult) <- vars
adult_corrs <- as.data.frame(rp_mat_adult)

# view results
teen_corrs
adult_corrs
```

RUN SHAPLEY 
```{r}
library(dplyr)
library(tidyr)
library(ShapleyValue)
library(kableExtra)

# Function to run Shapley and return formatted output
run_shapley <- function(data, dv_name) {
  shap_df <- data %>%
    dplyr::select(all_of(c(dv_name, "total_risk", "zuckerman.mean.z",
                    "barrets.sum.z", "foraging.z", "sex"))) %>%
    drop_na()

  # Print sample size used
  cat("N used (complete cases):", nrow(shap_df), "\n")

  # DV and predictors
  y <- shap_df[[dv_name]]
  x <- shap_df %>% dplyr::select(-all_of(dv_name)) %>% as.data.frame()

  # Run Shapley value analysis
  shap_values <- shapleyvalue(y = y, x = x)

  # Format output
  shap_df_out <- as.data.frame(shap_values)
  percent_row <- round(as.numeric(shap_df_out[2, ]) * 100, 2)
  shap_df_out[2, ] <- paste0(percent_row, "%")
  rownames(shap_df_out) <- c("Shapley Value", "Percent of R²")

  return(shap_df_out)
}

# --- Run separately for Teens (<3000) and Adults (>3000) ---
shapley_results_teen <- run_shapley(df_run %>% filter(PID < 3000), "mtes_zscore")
shapley_results_adult <- run_shapley(df_run %>% filter(PID > 3000), "mtes_zscore")

# --- Print nicely formatted tables ---
print(
  kbl(shapley_results_teen, align = "c",
      caption = "Shapley Value Regression for MTES (Teens)") %>%
    kable_classic(full_width = FALSE, html_font = "Cambria")
)

print(
  kbl(shapley_results_adult, align = "c",
      caption = "Shapley Value Regression for MTES (Adults)") %>%
    kable_classic(full_width = FALSE, html_font = "Cambria")
)

```

MEDIATIONS
```{r}

library(dplyr)
library(mediation)

# ---- Teens (PID < 3000) ----
teen_df <- df_run %>%
  filter(PID < 3000) %>%
  dplyr::select(mtes_zscore, total_risk, zuckerman.mean.z, barrets.sum.z, foraging.z) %>%
  drop_na()

# Zuckerman → Total Risk → MTES
med_model_zuck_t <- lm(total_risk ~ zuckerman.mean.z, data = teen_df)
out_model_zuck_t <- lm(mtes_zscore ~ zuckerman.mean.z + total_risk, data = teen_df)

med_teen_zuck <- mediation::mediate(
  med_model_zuck_t,
  out_model_zuck_t,
  treat = "zuckerman.mean.z",
  mediator = "total_risk",
  boot = TRUE,
  sims = 1000
)

# Barretts → Total Risk → MTES
med_model_bar_t <- lm(total_risk ~ barrets.sum.z, data = teen_df)
out_model_bar_t <- lm(mtes_zscore ~ barrets.sum.z + total_risk, data = teen_df)

med_teen_bar <- mediation::mediate(
  med_model_bar_t,
  out_model_bar_t,
  treat = "barrets.sum.z",
  mediator = "total_risk",
  boot = TRUE,
  sims = 1000
)

# Foraging → Total Risk → MTES
med_model_forage_t <- lm(total_risk ~ foraging.z, data = teen_df)
out_model_forage_t <- lm(mtes_zscore ~ foraging.z + total_risk, data = teen_df)

med_teen_forage <- mediation::mediate(
  med_model_forage_t,
  out_model_forage_t,
  treat = "foraging.z",
  mediator = "total_risk",
  boot = TRUE,
  sims = 1000
)


# ---- Adults (PID > 3000) ----
adult_df <- df_run %>%
  filter(PID > 3000) %>%
  dplyr::select(mtes_zscore, total_risk, zuckerman.mean.z, barrets.sum.z, foraging.z) %>%
  drop_na()

# Zuckerman → Total Risk → MTES
med_model_zuck_a <- lm(total_risk ~ zuckerman.mean.z, data = adult_df)
out_model_zuck_a <- lm(mtes_zscore ~ zuckerman.mean.z + total_risk, data = adult_df)

med_adult_zuck <- mediation::mediate(
  med_model_zuck_a,
  out_model_zuck_a,
  treat = "zuckerman.mean.z",
  mediator = "total_risk",
  boot = TRUE,
  sims = 1000
)

# Barretts → Total Risk → MTES
med_model_bar_a <- lm(total_risk ~ barrets.sum.z, data = adult_df)
out_model_bar_a <- lm(mtes_zscore ~ barrets.sum.z + total_risk, data = adult_df)

med_adult_bar <- mediation::mediate(
  med_model_bar_a,
  out_model_bar_a,
  treat = "barrets.sum.z",
  mediator = "total_risk",
  boot = TRUE,
  sims = 1000
)

# Foraging → Total Risk → MTES
med_model_forage_a <- lm(total_risk ~ foraging.z, data = adult_df)
out_model_forage_a <- lm(mtes_zscore ~ foraging.z + total_risk, data = adult_df)

med_adult_forage <- mediation::mediate(
  med_model_forage_a,
  out_model_forage_a,
  treat = "foraging.z",
  mediator = "total_risk",
  boot = TRUE,
  sims = 1000
)


# ---- Print results ----
cat("\n=== Teens: Zuckerman → Total Risk → MTES ===\n")
summary(med_teen_zuck)

cat("\n=== Teens: Barretts → Total Risk → MTES ===\n")
summary(med_teen_bar)

cat("\n=== Teens: Foraging → Total Risk → MTES ===\n")
summary(med_teen_forage)

cat("\n=== Adults: Zuckerman → Total Risk → MTES ===\n")
summary(med_adult_zuck)

cat("\n=== Adults: Barretts → Total Risk → MTES ===\n")
summary(med_adult_bar)

cat("\n=== Adults: Foraging → Total Risk → MTES ===\n")
summary(med_adult_forage)




```

Rerunning risk split up correlations
```{r}

library(Hmisc)
library(dplyr)

# vars of interest
vars <- c("mtes_zscore", "zuckerman.mean.z", "barrets.sum.z",
          "positiverisk_ever_mean.z", "negativerisk_ever_mean.z", "yrbs_var.z", "foraging.z")

# helper: rcorr -> lower-tri "r, p=" table
corr_rp <- function(data, vars) {
  num_df <- data[, vars, drop = FALSE]
  res <- Hmisc::rcorr(as.matrix(num_df))   # pairwise complete by default
  rp_mat <- matrix("", ncol = ncol(num_df), nrow = ncol(num_df))
  rp_mat[lower.tri(rp_mat)] <- paste0(
    round(res$r[lower.tri(res$r)], 2),
    ", p=", round(res$P[lower.tri(res$P)], 3)
  )
  colnames(rp_mat) <- rownames(rp_mat) <- colnames(num_df)
  as.data.frame(rp_mat)
}

# --- All participants ---
corr_all  <- corr_rp(df_run, vars)

# --- Teen cohort (PID < 3000) ---
corr_teen <- corr_rp(dplyr::filter(df_run, PID < 3000), vars)

# --- Adult cohort (PID > 3000) ---
corr_adult <- corr_rp(dplyr::filter(df_run, PID > 3000), vars)

# view
corr_all
corr_teen
corr_adult
```

Re run the risk-split hierachical regression
```{r}
# Load required packages
library(dplyr)
library(lm.beta)

# --- Teen Cohort (PID < 3000) ---
teen_df <- df_run %>%
  filter(PID < 3000) %>%
  dplyr::select(
    mtes_zscore, sex, barrets.sum.z, zuckerman.mean.z,
    foraging.z,                             # <-- added
    yrbs_var.z,
    positiverisk_ever_mean.z, negativerisk_ever_mean.z
  ) %>%
  na.omit()

# Step models (now 4 steps)
teen_m1 <- lm(mtes_zscore ~ sex + barrets.sum.z, data = teen_df)
teen_m2 <- lm(mtes_zscore ~ sex + barrets.sum.z + zuckerman.mean.z, data = teen_df)
teen_m3 <- lm(mtes_zscore ~ sex + barrets.sum.z + zuckerman.mean.z + foraging.z, data = teen_df)  # <-- new step
teen_m4 <- lm(mtes_zscore ~ sex + barrets.sum.z + zuckerman.mean.z + foraging.z +
                          yrbs_var.z + positiverisk_ever_mean.z +
                          negativerisk_ever_mean.z, data = teen_df)

# Standardized betas
teen_m1_std <- lm.beta(teen_m1)
teen_m2_std <- lm.beta(teen_m2)
teen_m3_std <- lm.beta(teen_m3)
teen_m4_std <- lm.beta(teen_m4)

# Output
cat("\n=== Teen Cohort: Model 1 ===\n"); summary(teen_m1); summary(teen_m1_std)
cat("\n=== Teen Cohort: Model 2 ===\n"); summary(teen_m2); summary(teen_m2_std)
cat("\n=== Teen Cohort: Model 3 ( + foraging.z ) ===\n"); summary(teen_m3); summary(teen_m3_std)
cat("\n=== Teen Cohort: Model 4 ( + risk vars ) ===\n"); summary(teen_m4); summary(teen_m4_std)

# Compare models (includes the new Model 3)
anova(teen_m1, teen_m2, teen_m3, teen_m4)


# --- Adult Cohort (PID > 3000) ---
adult_df <- df_run %>%
  filter(PID > 3000) %>%
  dplyr::select(
    mtes_zscore, sex, barrets.sum.z, zuckerman.mean.z,
    foraging.z,                             # <-- added
    yrbs_var.z,
    positiverisk_ever_mean.z, negativerisk_ever_mean.z
  ) %>%
  na.omit()

# Step models (now 4 steps)
adult_m1 <- lm(mtes_zscore ~ sex + barrets.sum.z, data = adult_df)
adult_m2 <- lm(mtes_zscore ~ sex + barrets.sum.z + zuckerman.mean.z, data = adult_df)
adult_m3 <- lm(mtes_zscore ~ sex + barrets.sum.z + zuckerman.mean.z + foraging.z, data = adult_df)  # <-- new step
adult_m4 <- lm(mtes_zscore ~ sex + barrets.sum.z + zuckerman.mean.z + foraging.z +
                          yrbs_var.z + positiverisk_ever_mean.z +
                          negativerisk_ever_mean.z, data = adult_df)

# Standardized betas
adult_m1_std <- lm.beta(adult_m1)
adult_m2_std <- lm.beta(adult_m2)
adult_m3_std <- lm.beta(adult_m3)
adult_m4_std <- lm.beta(adult_m4)

# Output
cat("\n=== Adult Cohort: Model 1 ===\n"); summary(adult_m1); summary(adult_m1_std)
cat("\n=== Adult Cohort: Model 2 ===\n"); summary(adult_m2); summary(adult_m2_std)
cat("\n=== Adult Cohort: Model 3 ( + foraging.z ) ===\n"); summary(adult_m3); summary(adult_m3_std)
cat("\n=== Adult Cohort: Model 4 ( + risk vars ) ===\n"); summary(adult_m4); summary(adult_m4_std)

# Compare models (includes the new Model 3)
anova(adult_m1, adult_m2, adult_m3, adult_m4)


```

RERUN STEIGER'S TEST FOR PARASOCIAL AND SOCIAL USAGE
```{r}
library(cocor)
library(dplyr)

# ---- Function to run Steiger's test for one predictor ----
run_steiger_df <- function(predictor, df) {
  r12 <- cor(df[[predictor]], df$ParasocialUsage.z, use = "pairwise.complete.obs")
  r13 <- cor(df[[predictor]], df$SocialUsage.z, use = "pairwise.complete.obs")
  r23 <- cor(df$ParasocialUsage.z, df$SocialUsage.z, use = "pairwise.complete.obs")
  n <- nrow(na.omit(df[, c(predictor, "ParasocialUsage.z", "SocialUsage.z")]))
  
  result <- cocor.dep.groups.overlap(r.jk = r12, r.jh = r13, r.kh = r23, n = n)
  steiger <- result@steiger1980
  
  # Return row
  data.frame(
    predictor = predictor,
    r_parasocial = round(r12, 3),
    r_social = round(r13, 3),
    r_diff = round(r12 - r13, 3),
    z = round(steiger$statistic, 3),
    p = round(steiger$p.value, 3),
    n = n
  )
}

# ---- Predictors ----
predictors <- c("yrbs_var.z",
                "positiverisk_ever_mean.z",
                "negativerisk_ever_mean.z")

# ---- Teen cohort ----
teen_df <- df_run %>% filter(PID < 3000)
steiger_results_teens <- do.call(rbind, lapply(predictors, run_steiger_df, df = teen_df))

# ---- Adult cohort ----
adult_df <- df_run %>% filter(PID > 3000)
steiger_results_adults <- do.call(rbind, lapply(predictors, run_steiger_df, df = adult_df))

# ---- Show results ----
steiger_results_teens
steiger_results_adults

```



###### Demographics ##### 

```{r}
library(dplyr)

# helper function for one row
get_ethnicity <- function(row) {
  races <- names(row)[row == 1]
  n <- length(races)
  
  if (n > 1) {
    return("multiple")
  } else if (n == 1 && races == "hispanic") {
    return("other")
  } else if (n == 1) {
    return(races)
  } else {
    return(NA_character_)
  }
}

# add ethnicity classification
df$ethnicity <- apply(
  df[, c("white","black","asian","native","african","hispanic","other")],
  1, get_ethnicity
)

# cohort 1: PID <= 3000
ethnicity_summary_cohort1 <- df %>%
  filter(PID <= 3000) %>%
  count(ethnicity) %>%
  mutate(percent = round(100 * n / sum(n), 1))

# cohort 2: PID > 3000
ethnicity_summary_cohort2 <- df %>%
  filter(PID > 3000) %>%
  count(ethnicity) %>%
  mutate(percent = round(100 * n / sum(n), 1))

ethnicity_summary_cohort1
ethnicity_summary_cohort2


```
SEX
```{r}
# relabel 1 = Female, 2 = Male
df$Gender <- factor(df$sex, levels = c(1, 2), labels = c("Female", "Male"))

# counts by PID cutoff
with(df, table(Gender, PID_group = ifelse(df$PID > 3000, ">3000", "<3000")))

```
AGE
```{r}
library(dplyr)

df %>%
  mutate(group = ifelse(PID > 3000, ">3000", "<=3000")) %>%
  group_by(group) %>%
  summarise(
    mean_age = mean(participant_age, na.rm = TRUE),
    sd_age   = sd(participant_age, na.rm = TRUE),
    n        = n()
  )

```


#### Descriptive STATS ##### 

PNRT/YRBS Risk Variables
```{r}
library(dplyr)
library(tidyr)

# Helper: summarize three variables as percentages
summarise_pct <- function(data) {
  data %>%
    transmute(
      `Negative Risk (%)` = negativerisk_ever_mean * 100,
      `Positive Risk (%)` = positiverisk_ever_mean * 100,
      `YRBS Variety (%)`  = yrbs_var * 100
    ) %>%
    pivot_longer(everything(), names_to = "Variable", values_to = "Percent") %>%
    summarise(
      Mean   = mean(Percent,   na.rm = TRUE),
      SD     = sd(Percent,     na.rm = TRUE),
      Min    = min(Percent,    na.rm = TRUE),
      Median = median(Percent, na.rm = TRUE),
      Max    = max(Percent,    na.rm = TRUE),
      .by = Variable
    ) %>%
    arrange(factor(Variable,
                   levels = c("Negative Risk (%)", "Positive Risk (%)", "YRBS Variety (%)"))) %>%
    mutate(across(Mean:Max, ~ round(.x, 2)))
}

# Teens (PID < 3000)
summary_teens  <- df %>% filter(PID < 3000) %>% summarise_pct()

# Adults (PID > 3000)
summary_adults <- df %>% filter(PID > 3000) %>% summarise_pct()

# (Optional) Combined table
summary_both <- bind_rows(
  summary_teens  %>% mutate(Group = "Teens (PID < 3000)"),
  summary_adults %>% mutate(Group = "Adults (PID > 3000)")
) %>%
  dplyr::select(Group, everything())

summary_teens
summary_adults
# View combined if desired:
# summary_both


```
total risk
```{r}
library(dplyr)

# Define the number of items in each risk set
n_neg <- 7  # replace with actual count of negative PNRT items
n_pos <- 14   # replace with actual count of positive PNRT items
n_yrbs <- 7  # fixed: 7 YRBS items

# Helper: compute total risk %
summarise_total_risk <- function(data) {
  data %>%
    mutate(
      total_endorsed = (negativerisk_ever_mean * n_neg) +
                       (positiverisk_ever_mean * n_pos) +
                       (yrbs_var * n_yrbs),
      total_possible = n_neg + n_pos + n_yrbs,
      total_risk_pct = (total_endorsed / total_possible) * 100
    ) %>%
    summarise(
      Mean = mean(total_risk_pct, na.rm = TRUE),
      SD   = sd(total_risk_pct,   na.rm = TRUE),
      Min  = min(total_risk_pct,  na.rm = TRUE),
      Max  = max(total_risk_pct,  na.rm = TRUE)
    ) %>%
    mutate(across(everything(), ~ round(.x, 2)))
}

# Teens
total_teens <- df %>% filter(PID < 3000) %>% summarise_total_risk()

# Adults
total_adults <- df %>% filter(PID > 3000) %>% summarise_total_risk()

# Optional combined
total_both <- bind_rows(
  total_teens %>% mutate(Group = "Teens (PID < 3000)"),
  total_adults %>% mutate(Group = "Adults (PID > 3000)")
)

total_teens
total_adults
# total_both

```

MTES Variables
```{r}
library(dplyr)
library(tidyr)
library(psych)

# ----------------------------
# 1) Cohort summaries (Mean, SD, Min, Max)
# ----------------------------

metric_vars <- c(
  "MTES_SocialMediaUse_TimeOnApp.sum",
  "MTES_PhoneChecking.mean",
  "MTES_PublicUpdates.mean",
  "SocialUsage",
  "ParasocialUsage"
)

summarise_vars <- function(data, vars) {
  data %>%
    dplyr::select(PID, all_of(vars)) %>%
    pivot_longer(-PID, names_to = "Variable", values_to = "Value") %>%
    summarise(
      Mean = mean(Value, na.rm = TRUE),
      SD   = sd(Value, na.rm = TRUE),
      Min  = min(Value, na.rm = TRUE),
      Max  = max(Value, na.rm = TRUE),
      .by  = Variable
    ) %>%
    mutate(across(c(Mean, SD, Min, Max), ~ round(.x, 2))) %>%
    arrange(match(Variable, metric_vars))
}

# Teens (PID < 3000)
summary_teens  <- df %>% filter(PID < 3000)  %>% summarise_vars(metric_vars)

# Adults (PID > 3000)
summary_adults <- df %>% filter(PID > 3000) %>% summarise_vars(metric_vars)

# Optional combined table with a Group column:
summary_both <- bind_rows(
  summary_teens  %>% mutate(Group = "Teens (PID < 3000)"),
  summary_adults %>% mutate(Group = "Adults (PID > 3000)")
) %>% relocate(Group)

# ----------------------------
# 2) Reliability (Cronbach’s α) across ALL participants
# ----------------------------

alpha_vars <- c(
  "MTES_SocialMediaUse_TimeOnApp.sum",
  "MTES_PhoneChecking.mean",
  "MTES_PublicUpdates.mean"
)

alpha_df  <- df %>% dplyr::select(all_of(alpha_vars)) %>% drop_na()
alpha_res <- psych::alpha(alpha_df)

# Quick, tidy readouts:
alpha_val <- round(alpha_res$total$std.alpha, 3)  # standardized alpha
alpha_n   <- nrow(alpha_df)

# View results
summary_teens
summary_adults
# summary_both   # uncomment to view combined
alpha_val
alpha_n
# print(alpha_res)  # uncomment for full reliability output


# Reliability (Cronbach's α) within cohorts (COMMENTED OUT)
# reliability_by_cohort <-
#   df %>%
#   mutate(Group = case_when(
#     PID < 3000 ~ "Teens (PID < 3000)",
#     PID > 3000 ~ "Adults (PID > 3000)",
#     TRUE       ~ NA_character_
#   )) %>%
#   filter(!is.na(Group)) %>%
#   group_by(Group) %>%
#   reframe({
#     dat <- dplyr::select(cur_data(), all_of(alpha_vars)) %>% drop_na()
#     tibble(
#       N_complete = nrow(dat),
#       Alpha = if (nrow(dat) >= 2) psych::alpha(dat)$total$std.alpha else NA_real_
#     )
#   }) %>%
#   mutate(Alpha = round(Alpha, 3))
# 
# reliability_by_cohort
```

Foraging
```{r}
library(dplyr)

foraging_by_cohort <-
  df %>%
  mutate(Cohort = case_when(
    PID < 3000 ~ "Teens (PID < 3000)",
    PID > 3000 ~ "Adults (PID > 3000)",
    TRUE       ~ NA_character_
  )) %>%
  filter(!is.na(Cohort)) %>%
  group_by(Cohort) %>%
  summarise(
    Mean = mean(foraging, na.rm = TRUE),
    SD   = sd(foraging, na.rm = TRUE),
    Min  = min(foraging, na.rm = TRUE),
    Max  = max(foraging, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(match(Cohort, c("Teens (PID < 3000)", "Adults (PID > 3000)"))) %>%
  mutate(across(c(Mean, SD, Min, Max), ~ round(.x, 2)))

foraging_by_cohort

```

Barrets
```{r}
library(dplyr)
library(readr)
library(psych)

# --- Load bar data ---
df_bar <- read_csv("/Users/dannyzweben/Desktop/CABLAB_Files/deft/coding/lite-study2/Lite_variables/bar.csv")

# --- Keep only PIDs that exist in df_run ---
df_bar <- df_bar %>%
  filter(PID %in% df_run$PID)

# --- Reverse score items where higher = less impulsive ---
# Based on your screenshot: reverse these items
reverse_items <- c("bar_dothings", "bar_attention", "bar_saythings", "bar_act")

# Find max scale value (assuming 1–4 Likert scale)
max_val <- 4

df_bar <- df_bar %>%
  mutate(across(all_of(reverse_items), ~ (max_val + 1) - ., .names = "rev_{col}"))

# --- Compute Cronbach’s alpha ---
# Select only scored items (reversed + non-reversed), exclude PID
scored_items <- c(
  "bar_plantasks", 
  "rev_bar_dothings", 
  "rev_bar_attention",
  "bar_selfcontrol", 
  "bar_concentrate", 
  "bar_careful",
  "rev_bar_saythings", 
  "rev_bar_act"
)

alpha_results <- psych::alpha(df_bar %>% dplyr::select(all_of(scored_items)))

print(alpha_results$total$raw_alpha)

# --- Create summed score ---
df_bar <- df_bar %>%
  rowwise() %>%
  mutate(barrets.sum = sum(c_across(all_of(scored_items)), na.rm = TRUE)) %>%
  ungroup()

# --- Descriptives for barrets (mean scoring) by cohort ---
barrets_desc <- df_bar %>%
  mutate(barrets.mean = barrets.sum / 8) %>%
  group_by(Cohort = ifelse(PID < 3000, "Teens", "Adults")) %>%
  summarise(
    mean = mean(barrets.mean, na.rm = TRUE),
    sd   = sd(barrets.mean, na.rm = TRUE),
    min  = min(barrets.mean, na.rm = TRUE),
    max  = max(barrets.mean, na.rm = TRUE),
    .groups = "drop"
  )

barrets_desc



```

Zuckerman
```{r}
library(dplyr)
library(readr)
library(psych)

# --- Read in Zuckerman data ---
df_zuck <- read_csv("/Users/dannyzweben/Desktop/CABLAB_Files/deft/coding/lite-study2/Lite_variables/zuck.csv")

# --- Keep only PIDs in df_run ---
df_zuck <- df_zuck %>%
  filter(PID %in% df_run$PID)

# --- Cronbach's alpha (drop PID first) ---
alpha_results <- psych::alpha(df_zuck %>% dplyr::select(-PID))

# --- Descriptives for zuckerman.mean by cohort ---
zuck_desc <- df %>%
  group_by(Cohort = ifelse(PID < 3000, "Teens", "Adults")) %>%
  summarise(
    mean = mean(zuckerman.mean, na.rm = TRUE),
    sd   = sd(zuckerman.mean, na.rm = TRUE),
    min  = min(zuckerman.mean, na.rm = TRUE),
    max  = max(zuckerman.mean, na.rm = TRUE),
    .groups = "drop"
  )

# Print results
alpha_zuck <- psych::alpha(df_zuck %>% dplyr::select(-PID))$total$raw_alpha

alpha_zuck
zuck_desc

```

